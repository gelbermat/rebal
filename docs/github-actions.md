# GitHub Actions CI/CD

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GitHub Actions –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞

### Workflow: CI/CD Pipeline (`.github/workflows/ci.yml`)

–ü–∞–π–ø–ª–∞–π–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤:

#### 1. üé® **Lint** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
- **Black** - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- **isort** - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤  
- **Flake8** - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

#### 2. üß™ **Test** - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–∞—Ç—Ä–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: Python 3.11, 3.12
- PostgreSQL —Å–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: –º–∏–Ω–∏–º—É–º 80%
- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Codecov

#### 3. üîí **Security** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **Safety** - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **Bandit** - –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞

#### 4. üê≥ **Docker** - –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤
- –ú–Ω–æ–≥–æ–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ (linux/amd64, linux/arm64)
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ GitHub Container Registry
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏

## –¢—Ä–∏–≥–≥–µ—Ä—ã

### Push —Å–æ–±—ã—Ç–∏—è
- **main** - –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω + Docker push
- **develop** - –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω + Docker push
- –î—Ä—É–≥–∏–µ –≤–µ—Ç–∫–∏ - –¢–æ–ª—å–∫–æ lint –∏ test

### Pull Request
- –õ—é–±—ã–µ PR –≤ **main** - –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω (–±–µ–∑ Docker push)

### Manual
- `workflow_dispatch` - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub UI

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ
- `GITHUB_TOKEN` - –¢–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ GitHub Container Registry
- `DATABASE_URL` - URL PostgreSQL –¥–ª—è —Ç–µ—Å—Ç–æ–≤

### –°–µ–∫—Ä–µ—Ç—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è)
–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `GITHUB_TOKEN`.

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### Poetry –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ö—ç—à –ø–æ —Ö–µ—à—É `poetry.lock`
- –û—Ç–¥–µ–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏ Python
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É

### Docker —Å–ª–æ–∏
- GitHub Actions cache –¥–ª—è Docker Buildx
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏

## Docker Registry

### GitHub Container Registry (ghcr.io)
–û–±—Ä–∞–∑—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ `ghcr.io/gelbermats/rebalancer` —Å —Ç–µ–≥–∞–º–∏:
- `main` - –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
- `develop` - –í–µ—Ä—Å–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `pr-{number}` - Pull request –≤–µ—Ä—Å–∏–∏
- `main-{sha}` / `develop-{sha}` - –í–µ—Ä—Å–∏–∏ –ø–æ –∫–æ–º–º–∏—Ç—É

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```bash
docker pull ghcr.io/gelbermats/rebalancer:main
docker run -p 8000:8000 ghcr.io/gelbermats/rebalancer:main
```

## –°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏

–î–æ–±–∞–≤—å—Ç–µ –±–µ–π–¥–∂ –≤ README:
```markdown
[![CI/CD](https://github.com/gelbermats/rebalancer/actions/workflows/ci.yml/badge.svg)](https://github.com/gelbermats/rebalancer/actions/workflows/ci.yml)
```

## –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ act (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
# macOS
brew install act

# Linux
curl https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
```

### –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ
```bash
# –¢–æ–ª—å–∫–æ lint
act -j lint

# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã
act -j test

# –í—Å–µ —ç—Ç–∞–ø—ã (–∫—Ä–æ–º–µ Docker)
act
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### GitHub Checks
- –í—Å–µ —ç—Ç–∞–ø—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- Pull Request –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö

### –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
- –û—Ç—á–µ—Ç—ã –ø–æ–∫—Ä—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Codecov
- Docker –æ–±—Ä–∞–∑—ã –≤ GitHub Container Registry

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°—Ä–µ–¥–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **Lint**: ~2-3 –º–∏–Ω—É—Ç—ã
- **Test** (–∫–∞–∂–¥–∞—è –≤–µ—Ä—Å–∏—è Python): ~3-5 –º–∏–Ω—É—Ç
- **Security**: ~2-3 –º–∏–Ω—É—Ç—ã  
- **Docker**: ~5-10 –º–∏–Ω—É—Ç
- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: ~12-20 –º–∏–Ω—É—Ç

### –°–æ–≤–µ—Ç—ã –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** - –£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** - Lint, Test, Security –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
3. **–£—Å–ª–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Docker** - –¢–æ–ª—å–∫–æ –¥–ª—è main/develop
4. **–ú–∞—Ç—Ä–∏—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Python

## Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### "Coverage check failed"
```bash
# –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
poetry run pytest --cov=app --cov-report=term-missing
poetry run coverage report --fail-under=80
```

#### "Docker build failed"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Dockerfile —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã (–Ω–µ –≤ .dockerignore)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ Actions

#### "Import sorting failed"
```bash
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
poetry run isort app/ tests/ utils/
```

#### "Formatting check failed"
```bash
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
poetry run black app/ tests/ utils/
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ª–∏–Ω—Ç–µ—Ä–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ
make lint

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
make test-cov

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∫ –≤ CI
make ci

# –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
make docker-build
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- `GITHUB_TOKEN` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –∑–∞–ø–∏—Å–∏ –≤ Container Registry
- –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –ò–∑–æ–ª—è—Ü–∏—è
- –ö–∞–∂–¥—ã–π job –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- Safety –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
- Bandit –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–¥ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤
–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.github/workflows/ci.yml`:

```yaml
  new-job:
    name: New Job
    runs-on: ubuntu-latest
    needs: [lint, test]  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # ... –≤–∞—à–∏ —à–∞–≥–∏
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Slack/Discord/Email –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ Actions –∏–∑ GitHub Marketplace.

### –î–µ–ø–ª–æ–π
–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–∞–ø –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞.